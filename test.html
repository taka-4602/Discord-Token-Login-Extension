<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Token Login - Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #36393f;
            color: white;
        }
        .test-section {
            background: #2f3136;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4752c4;
        }
        .result {
            background: #202225;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Discord Token Login Extension - Test Page</h1>
    
    <div class="test-section">
        <h2>1. Extension Installation Check</h2>
        <button id="btn-check-extension">Check Extension</button>
        <div id="extension-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Open Extension Popup</h2>
        <p>Click the extension icon in your browser toolbar</p>
        <p>Then test the following features:</p>
        <ul>
            <li>Click "Show Saved Accounts ▼" - should expand/collapse</li>
            <li>Click "Bulk Import Tokens ▼" - should expand/collapse</li>
            <li>Try adding test tokens</li>
            <li>Check memo functionality</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>3. Test Token Format Parser</h2>
        <textarea id="test-tokens" rows="6" style="width: 100%; padding: 10px; background: #40444b; color: white; border: 1px solid #202225; border-radius: 4px;">test_token_1
test_token_2/test_token_3
test_token_4,test_token_5
test_token_6 test_token_7</textarea>
        <br>
        <button id="btn-test-parser">Test Parser</button>
        <div id="parser-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Storage Test</h2>
        <button id="btn-add-account">Add Test Account</button>
        <button id="btn-view-storage">View Storage</button>
        <button id="btn-clear-storage">Clear Storage</button>
        <div id="storage-result" class="result"></div>
    </div>
    
    <section>
        <h2>Tab Version Test</h2>
        <p>Test tab.html functionality outside Chrome extension context:</p>
        <div id="tab-test">
            <button onclick="testTabVersion()">Test Tab Version</button>
            <div id="tab-result"></div>
        </div>
    </section>

    <script>
        // 安全な storage ポリフィル
        const storage = (() => {
            const hasChromeStorage = typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local;
            if (hasChromeStorage) {
                return {
                    get(keys, cb) {
                        try { chrome.storage.local.get(keys, cb); } catch (e) { console.error('chrome.storage.local.get error', e); cb({}); }
                    },
                    set(obj, cb) {
                        try { chrome.storage.local.set(obj, cb); } catch (e) { console.error('chrome.storage.local.set error', e); cb && cb(); }
                    },
                    clear(cb) {
                        try { chrome.storage.local.clear(cb); } catch (e) { console.error('chrome.storage.local.clear error', e); cb && cb(); }
                    },
                    available: true
                };
            }
            // localStorage 版
            return {
                get(keys, cb) {
                    const out = {};
                    try {
                        const list = Array.isArray(keys) ? keys : (typeof keys === 'object' ? Object.keys(keys) : [keys]);
                        for (const k of list) {
                            const raw = localStorage.getItem(k);
                            out[k] = raw ? JSON.parse(raw) : (typeof keys === 'object' ? keys[k] : undefined);
                        }
                    } catch (e) { console.error('localStorage get error', e); }
                    cb(out);
                },
                set(obj, cb) {
                    try {
                        for (const [k, v] of Object.entries(obj)) {
                            localStorage.setItem(k, JSON.stringify(v));
                        }
                    } catch (e) { console.error('localStorage set error', e); }
                    cb && cb();
                },
                clear(cb) {
                    try { localStorage.clear(); } catch (e) { console.error('localStorage clear error', e); }
                    cb && cb();
                },
                available: false
            };
        })();

        function parseTokensText(inputText) {
            const tokens = [];
            const lines = (inputText || '').split(/\r?\n/);
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || /^\s*(#|\/\/)/.test(trimmedLine)) continue;
                let lineTokens = [];
                if (trimmedLine.includes(',')) {
                    lineTokens = trimmedLine.split(',');
                } else if (trimmedLine.includes('/')) {
                    lineTokens = trimmedLine.split('/');
                } else if (trimmedLine.includes(' ')) {
                    lineTokens = trimmedLine.split(/\s+/);
                } else {
                    lineTokens = [trimmedLine];
                }
                for (const token of lineTokens) {
                    const cleanToken = token.trim().replace(/^["']|["']$/g, '');
                    if (cleanToken) tokens.push(cleanToken);
                }
            }
            return [...new Set(tokens)];
        }

        function init() {
            const btnCheck = document.getElementById('btn-check-extension');
            const extensionResult = document.getElementById('extension-result');
            const btnParser = document.getElementById('btn-test-parser');
            const parserInput = document.getElementById('test-tokens');
            const parserResult = document.getElementById('parser-result');
            const btnAdd = document.getElementById('btn-add-account');
            const btnView = document.getElementById('btn-view-storage');
            const btnClear = document.getElementById('btn-clear-storage');
            const storageResult = document.getElementById('storage-result');

            if (btnCheck && extensionResult) {
                btnCheck.addEventListener('click', () => {
                    const available = storage.available;
                    extensionResult.textContent = available ? 'Extension API available' : 'Extension API not available (fallback to localStorage)';
                    extensionResult.style.color = available ? '#3ba55c' : '#f23f42';
                });
            }

            if (btnParser && parserInput && parserResult) {
                btnParser.addEventListener('click', () => {
                    const tokens = parseTokensText(parserInput.value);
                    parserResult.textContent = `Parsed ${tokens.length} tokens:\n${JSON.stringify(tokens, null, 2)}`;
                });
            }

            if (btnAdd && storageResult) {
                btnAdd.addEventListener('click', () => {
                    storage.get(['accounts'], (res) => {
                        const accounts = res.accounts || [];
                        accounts.push({
                            id: 'test_' + Date.now(),
                            username: 'TestUser',
                            global_name: 'Test User',
                            avatar: 'https://cdn.discordapp.com/embed/avatars/0.png',
                            token: 'test_token_' + Date.now(),
                            memo: 'Test memo',
                            savedAt: Date.now()
                        });
                        storage.set({ accounts }, () => {
                            storageResult.textContent = `Test account added. Total: ${accounts.length}`;
                            storageResult.style.color = '#3ba55c';
                        });
                    });
                });
            }

            if (btnView && storageResult) {
                btnView.addEventListener('click', () => {
                    storage.get(['accounts'], (res) => {
                        storageResult.textContent = JSON.stringify(res.accounts || [], null, 2);
                        storageResult.style.color = 'inherit';
                    });
                });
            }

            if (btnClear && storageResult) {
                btnClear.addEventListener('click', () => {
                    if (confirm('Clear all storage?')) {
                        storage.clear(() => {
                            storageResult.textContent = 'Storage cleared';
                            storageResult.style.color = '#3ba55c';
                        });
                    }
                });
            }
        }

        function testTabVersion() {
            const result = document.getElementById('tab-result');
            result.innerHTML = '<p>Opening tab.html in new window...</p>';
            
            // tab.htmlを新しいウィンドウで開く
            try {
                const newWindow = window.open('chrome_extension/tab.html', '_blank');
                if (newWindow) {
                    result.innerHTML = '<p style="color: green;">✓ Tab version opened successfully</p>';
                } else {
                    result.innerHTML = '<p style="color: red;">✗ Failed to open tab version (popup blocked?)</p>';
                }
            } catch (e) {
                result.innerHTML = '<p style="color: red;">✗ Error opening tab version: ' + e.message + '</p>';
            }
        }

        // DOMContentLoaded 後に初期化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
